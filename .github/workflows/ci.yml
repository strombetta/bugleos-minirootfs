name: CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

env:
  MAKEFLAGS: -j2

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [[ -n "${GITHUB_RUN_NUMBER:-}" ]]; then
            VERSION="0.0.${GITHUB_RUN_NUMBER}"
          else
            VERSION="$(date +'%Y%m%d')"
          fi

          echo "VERSION=${VERSION}" | tee version.env
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "VERSION_FILE=${GITHUB_WORKSPACE}/version.env" >> "$GITHUB_ENV"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential wget bison flex texinfo bc git python3 gawk \
            libgmp-dev libmpfr-dev libmpc-dev file

      - name: Cache downloaded sources
        uses: actions/cache@v4
        with:
          path: sources
          key: ${{ runner.os }}-sources-${{ hashFiles('config.mk') }}
          restore-keys: |
            ${{ runner.os }}-sources-

      - name: Cache build outputs
        uses: actions/cache@v4
        with:
          path: |
            toolchain
            sysroot
            build
            output
          key: ${{ runner.os }}-build-${{ steps.version.outputs.version }}-${{ hashFiles('config.mk', 'Makefile', 'scripts/**', 'patches/**', 'tests/**') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ steps.version.outputs.version }}-

      - name: Download sources
        run: make download

      - name: Build and run tests
        env:
          VERSION: ${{ steps.version.outputs.version }}
          VERSION_FILE: ${{ github.workspace }}/version.env
        run: make test

      - name: Persist version metadata with outputs
        env:
          OUTPUT: ${{ github.workspace }}/output
        run: |
          mkdir -p "$OUTPUT"
          cp version.env "$OUTPUT/version.env"

      - name: Upload version metadata
        uses: actions/upload-artifact@v4
        with:
          name: version-env
          path: version.env

      - name: Upload generated image
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bugleos-minirootfs-${{ steps.version.outputs.version }}
          path: |
            output/*.tar.gz
            output/version.env
          if-no-files-found: ignore

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download version metadata
        uses: actions/download-artifact@v4
        with:
          name: version-env

      - name: Read version
        id: version
        run: |
          . version.env
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Download generated image
        uses: actions/download-artifact@v4
        with:
          name: bugleos-minirootfs-${{ needs.build.outputs.version }}
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: BugleOS ${{ steps.version.outputs.version }}
          files: artifacts/*.tar.gz
